#!/bin/bash

set -eu

echo "+++ :git: Setting git checkout directory"

MOST="$(dirname $BUILDKITE_BUILD_CHECKOUT_PATH)"
TAIL="$(basename $BUILDKITE_BUILD_CHECKOUT_PATH)"
NEW_BUILDKITE_BUILD_CHECKOUT_PATH="$MOST/$BUILDKITE_AGENT_NAME/$TAIL"

if [[ ! -z ${BKUNIQUENAMEHOOK_TEST+x} ]]
then
    echo "BUILDKITE_BUILD_CHECKOUT_PATH=$NEW_BUILDKITE_BUILD_CHECKOUT_PATH"
fi

if [[ -d "$BUILDKITE_BUILD_CHECKOUT_PATH" ]]
then
    echo ":file_folder: Moving old checkout"
    mkdir -p "$(dirname "$NEW_BUILDKITE_BUILD_CHECKOUT_PATH")"
    ls "$(dirname "$NEW_BUILDKITE_BUILD_CHECKOUT_PATH")"
    mv "$BUILDKITE_BUILD_CHECKOUT_PATH" "$NEW_BUILDKITE_BUILD_CHECKOUT_PATH"
else
    mkdir -p "$NEW_BUILDKITE_BUILD_CHECKOUT_PATH"
fi

export BUILDKITE_BUILD_CHECKOUT_PATH="$NEW_BUILDKITE_BUILD_CHECKOUT_PATH"
